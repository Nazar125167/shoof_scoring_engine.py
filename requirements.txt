streamlit
langgraph
pydantic
numpy
# يمكن إضافة مكتبات أخرى إذا كنت تستخدمها في حساباتك
# مثل:
# pandas
# requests
from typing import Dict, Any

class ShoofTrustAgent:
    """
    محرك الحساب الرئيسي لمؤشر الثقة (9.7).
    يحتوي على البيانات الخام والمعادلات الرياضية لضمان دقة المؤشر.
    """

    def __init__(self):
        # 1. الأوزان الافتراضية (مجموعها = 1.0)
        self.trust_weights = {
            'quality': 0.30,
            'reliability': 0.25,
            'speed': 0.20,
            'price': 0.20,
            'extra': 0.05
        }
        
        # 2. بيانات الشركات الافتراضية (كمثال للـ Demo)
        # يجب أن تكون هذه البيانات هي المدخلات في معادلاتك
        self.companies_data = {
            'كهرباء الدوحة': {
                'quality_metrics': 90, # مقياس الجودة
                'reliability_metrics': 85, # مقياس الموثوقية
                'speed_metrics': 70, # مقياس السرعة
                'price_metrics': 95, # مقياس السعر (كلما كان أقل كان أفضل)
                'extra_metrics': 80
            },
            'CleanMax للتنظيف': {
                'quality_metrics': 80,
                'reliability_metrics': 65,
                'speed_metrics': 90,
                'price_metrics': 75,
                'extra_metrics': 85
            }
            # يمكنك إضافة المزيد من الشركات هنا للـ Demo
        }
        
    # === الدوال المساعدة لحساب كل مكون (كمثال) ===
    
    def _calculate_quality_score(self, company_data: Dict) -> float:
        # مثال: حساب بسيط
        return company_data['quality_metrics'] * 1.0

    def _calculate_reliability_score(self, company_data: Dict) -> float:
        return company_data['reliability_metrics'] * 1.0

    def _calculate_speed_score(self, company_data: Dict) -> float:
        return company_data['speed_metrics'] * 1.0

    def _calculate_price_score(self, company_data: Dict) -> float:
        # ملاحظة: إذا كانت النتيجة الأعلى أفضل (مثل 95/100) فهذا هو الكود
        return company_data['price_metrics'] * 1.0
        
    def _calculate_extra_score(self, company_data: Dict) -> float:
        return company_data['extra_metrics'] * 1.0
        
    # === دالة الحساب النهائية (تستخدم في shoof_ai_flow.py) ===

    def calculate_trust_score(self, company_name: str, custom_weights: Dict = None) -> Dict:
        """حساب مؤشر الثقة الفعلي باستخدام الأوزان المخصصة"""
        
        company_data = self.companies_data.get(company_name)
        if not company_data:
            # نعود لشركة افتراضية إن لم نجد الاسم
            company_data = self.companies_data['كهرباء الدوحة']
            
        weights = custom_weights if custom_weights else self.trust_weights

        # 1. حساب المكونات الأربعة الأساسية
        quality_score = self._calculate_quality_score(company_data)
        reliability_score = self._calculate_reliability_score(company_data)
        speed_score = self._calculate_speed_score(company_data)
        price_score = self._calculate_price_score(company_data)
        extra_score = self._calculate_extra_score(company_data)

        # 2. حساب النتيجة النهائية باستخدام الأوزان المخصصة
        final_score = (
            quality_score * weights['quality'] +
            reliability_score * weights['reliability'] +
            speed_score * weights['speed'] +
            price_score * weights['price'] +
            extra_score * weights['extra']
        )
        
        # 3. تحويل إلى مقياس 9.7
        # نقوم بتقسيم المجموع النهائي (الذي يجب أن يكون من 0 إلى 100) على 100 ثم ضربه في 9.7
        shoof_index = (final_score / 100) * 9.7
        
        return {
            'shoof_index': round(shoof_index, 1),
            'percentage': round(final_score, 1),
            'breakdown': {
                'quality': round(quality_score, 1),
                'reliability': round(reliability_score, 1),
                'speed': round(speed_score, 1),
                'price': round(price_score, 1),
                'extra': round(extra_score, 1),
            },
            'weights': weights
        }
