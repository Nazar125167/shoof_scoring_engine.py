from typing import Dict, List
from shoof_scoring_engine import ShoofTrustAgent # ุงุณุชูุฑุงุฏ ูุญุฑู ุงูุญุณุงุจ ุงูุฏููู
# ุฅูุดุงุก ูุซูู ููุดุบู ุงูุญุณุงุจ (ูุชู ุงุณุชูุฑุงุฏ ูุฐุง ูุฑุฉ ูุงุญุฏุฉ)
SCORING_ENGINE = ShoofTrustAgent()

def get_custom_weights(priority: str) -> Dict:
    """ุชุนุฏูู ุงูุฃูุฒุงู ูุชุนูุณ ุฃููููุฉ ุงูุนููู"""
    # ูุจุฏุฃ ุจุงูุฃูุฒุงู ุงูุงูุชุฑุงุถูุฉ
    base_weights = SCORING_ENGINE.trust_weights.copy()
    
    if priority == "ุฌูุฏุฉ":
        # ูุฒูุฏ ูุฒู ุงูุฌูุฏุฉ ูุงูููุซูููุฉ ููููู ุงูุณุนุฑ
        base_weights['quality'] = 0.45  # ุฒูุงุฏุฉ
        base_weights['reliability'] = 0.30 # ุฒูุงุฏุฉ
        base_weights['price'] = 0.05    # ุชูููู
        base_weights['speed'] = 0.15 
        base_weights['extra'] = 0.05 
        
    elif priority == "ุณุนุฑ":
        # ูุฒูุฏ ูุฒู ุงูุณุนุฑ ูุงูุณุฑุนุฉ
        base_weights['price'] = 0.35    # ุฒูุงุฏุฉ
        base_weights['speed'] = 0.30    # ุฒูุงุฏุฉ
        base_weights['quality'] = 0.15   # ุชูููู
        base_weights['reliability'] = 0.15
        base_weights['extra'] = 0.05
        
    # ููุงุญุธุฉ: ูุฌููุน ุงูุฃูุฒุงู ูุฌุจ ุฃู ูููู 1.0 (100%)
    return base_weights
def run_shoof_flow(company_name: str, priority: str) -> str:
    """
    ุชุดุบูู ุงูุชุฏูู ุงููุงูู ูุชุญููู ุดููู:
    1. ูุญุฏุฏ ุงูุฃูุฒุงู ุงููุฎุตุตุฉ.
    2. ูุณุชุฏุนู ูุญุฑู ุงูุญุณุงุจ.
    3. ูููุฏ ุงูุชูุฑูุฑ ุงูููุงุฆู.
    """
    
    # 1. ุงูุญุตูู ุนูู ุงูุฃูุฒุงู ุงููุฎุตุตุฉ ุจูุงุกู ุนูู ุงูุฃููููุฉ
    custom_weights = get_custom_weights(priority)
    
    # 2. ุงุณุชุฏุนุงุก ูุญุฑู ุงูุญุณุงุจ ุงููุนูู
    trust_result = SCORING_ENGINE.calculate_trust_score(company_name, custom_weights)
    
    if 'error' in trust_result:
        return f"โ๏ธ **ุฎุทุฃ ูู ุงูุชุญููู:** {trust_result['error']}"
        
    # ุชุญุฏูุฏ ููุทุฉ ุงูุถุนู ุงูุฃูุจุฑ (ููุชูุตูุฉ)
    # ูุฌุฏ ุงููุนูุงุฑ ุตุงุญุจ ุฃูู ูุชูุฌุฉ (ุฃูู ูู 100)
    weakest_link_tuple = min(trust_result['breakdown'].items(), key=lambda item: item[1])
    weakest_link_name = weakest_link_tuple[0]

    # 3. ุจูุงุก ุงูุชูุฑูุฑ ุงููุตู (ูุฌุจ ุฃู ูููู ูููุนุงู ููุง)
    if priority == "ุฌูุฏุฉ":
        recommendation = f"โ **ุงูุชูุตูุฉ:** ูุฌุจ ุชุทุจูู ูุธุงู 'Checklist' ุตุงุฑู ูุถูุงู ุงูุชูุญูุฏ (ูุฃู ูุฐู ุฃููููุชูู). ุงูุชุฑููุฒ ุนูู ุชุญุณูู **{weakest_link_name}**."
    else:
        recommendation = f"๐ **ุงูุชูุตูุฉ:** ูุฌุจ ูุถุน ุณูู ุฒููู ูุฎูุถ ุชูููุฉ ุงูุนูุงูุฉ ุงููุจุงุดุฑุฉ (ูุฃู ูุฐู ุฃููููุชูู). ุงูุชุฑููุฒ ุนูู ุฎูุถ ุงูุชูุงููู ุงููุฑุชุจุทุฉ ุจู **{weakest_link_name}**."

    # ุชุฌููุน ุงูุชูุฑูุฑ ุงูููุงุฆู ุจุตูุบุฉ Markdown
    report = f"""
    # ๐ ุชูุฑูุฑ ุดููู ุงููุฎุตุต ูู {company_name}
    ## ๐ฏ ูุคุดุฑ ุงูุซูุฉ ุงูููุงุฆู: **{trust_result['shoof_index']}/9.7** ({trust_result['percentage']}%)
    
    ---
    ## ๐ ุชูุฒูุน ุงูุฃุฏุงุก (ุจูุงุกู ุนูู ุงูุฃูุฒุงู ุงูุฌุฏูุฏุฉ)
    * **ุงูุฌูุฏุฉ:** {trust_result['breakdown']['quality']}/100
    * **ุงูููุซูููุฉ:** {trust_result['breakdown']['reliability']}/100
    * **ุงูุณุฑุนุฉ:** {trust_result['breakdown']['speed']}/100
    * **ุงูุณุนุฑ:** {trust_result['breakdown']['price']}/100
    
    ---
    ## โ๏ธ ุงูุชุดุฎูุต ุงูุฌุฐุฑู
    ุงูุณุจุจ ุงูุฑุฆูุณู ูุชุฏูู ุงููุคุดุฑ ููุงุฑูุฉ ุจุฃููููุชูู ูู ุถุนู ูุงุถุญ ูู ูุนูุงุฑ **{weakest_link_name}**.
    
    ---
    ## ๐ก ุงูุชูุตูุฉ (ููุฎุตุตุฉ ูุฃููููุชูู: {priority})
    {recommendation}
    """
    
    def run_shoof_flow(company_name: str, priority: str) -> str:
    """
    ุชุดุบูู ุงูุชุฏูู ุงููุงูู ูุชุญููู ุดููู:
    1. ูุญุฏุฏ ุงูุฃูุฒุงู ุงููุฎุตุตุฉ.
    2. ูุณุชุฏุนู ูุญุฑู ุงูุญุณุงุจ.
    3. ูููุฏ ุงูุชูุฑูุฑ ุงูููุงุฆู.
    """
    
    # 1. ุงูุญุตูู ุนูู ุงูุฃูุฒุงู ุงููุฎุตุตุฉ ุจูุงุกู ุนูู ุงูุฃููููุฉ
    custom_weights = get_custom_weights(priority)
    
    # 2. ุงุณุชุฏุนุงุก ูุญุฑู ุงูุญุณุงุจ ุงููุนูู
    trust_result = SCORING_ENGINE.calculate_trust_score(company_name, custom_weights)
    
    if 'error' in trust_result:
        return f"โ๏ธ **ุฎุทุฃ ูู ุงูุชุญููู:** {trust_result['error']}"
        
    # ุชุญุฏูุฏ ููุทุฉ ุงูุถุนู ุงูุฃูุจุฑ (ููุชูุตูุฉ)
    # ูุฌุฏ ุงููุนูุงุฑ ุตุงุญุจ ุฃูู ูุชูุฌุฉ (ุฃูู ูู 100)
    weakest_link_tuple = min(trust_result['breakdown'].items(), key=lambda item: item[1])
    weakest_link_name = weakest_link_tuple[0]

    # 3. ุจูุงุก ุงูุชูุฑูุฑ ุงููุตู (ูุฌุจ ุฃู ูููู ูููุนุงู ููุง)
    if priority == "ุฌูุฏุฉ":
        recommendation = f"โ **ุงูุชูุตูุฉ:** ูุฌุจ ุชุทุจูู ูุธุงู 'Checklist' ุตุงุฑู ูุถูุงู ุงูุชูุญูุฏ (ูุฃู ูุฐู ุฃููููุชูู). ุงูุชุฑููุฒ ุนูู ุชุญุณูู **{weakest_link_name}**."
    else:
        recommendation = f"๐ **ุงูุชูุตูุฉ:** ูุฌุจ ูุถุน ุณูู ุฒููู ูุฎูุถ ุชูููุฉ ุงูุนูุงูุฉ ุงููุจุงุดุฑุฉ (ูุฃู ูุฐู ุฃููููุชูู). ุงูุชุฑููุฒ ุนูู ุฎูุถ ุงูุชูุงููู ุงููุฑุชุจุทุฉ ุจู **{weakest_link_name}**."

    # ุชุฌููุน ุงูุชูุฑูุฑ ุงูููุงุฆู ุจุตูุบุฉ Markdown
    report = f"""
    # ๐ ุชูุฑูุฑ ุดููู ุงููุฎุตุต ูู {company_name}
    ## ๐ฏ ูุคุดุฑ ุงูุซูุฉ ุงูููุงุฆู: **{trust_result['shoof_index']}/9.7** ({trust_result['percentage']}%)
    
    ---
    ## ๐ ุชูุฒูุน ุงูุฃุฏุงุก (ุจูุงุกู ุนูู ุงูุฃูุฒุงู ุงูุฌุฏูุฏุฉ)
    * **ุงูุฌูุฏุฉ:** {trust_result['breakdown']['quality']}/100
    * **ุงูููุซูููุฉ:** {trust_result['breakdown']['reliability']}/100
    * **ุงูุณุฑุนุฉ:** {trust_result['breakdown']['speed']}/100
    * **ุงูุณุนุฑ:** {trust_result['breakdown']['price']}/100
    
    ---
    ## โ๏ธ ุงูุชุดุฎูุต ุงูุฌุฐุฑู
    ุงูุณุจุจ ุงูุฑุฆูุณู ูุชุฏูู ุงููุคุดุฑ ููุงุฑูุฉ ุจุฃููููุชูู ูู ุถุนู ูุงุถุญ ูู ูุนูุงุฑ **{weakest_link_name}**.
    
    ---
    ## ๐ก ุงูุชูุตูุฉ (ููุฎุตุตุฉ ูุฃููููุชูู: {priority})
    {recommendation}
    """
    
    return report
